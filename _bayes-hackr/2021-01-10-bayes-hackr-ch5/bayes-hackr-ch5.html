<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Chapter 5</title>
  
  <meta property="description" itemprop="description" content="Reproducing Chapter 5 of Bayesian Methods for Hackers in R + Stan"/>
  
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-01-08"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-01-08"/>
  <meta name="article:author" content="J. Duncan"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Chapter 5"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Reproducing Chapter 5 of Bayesian Methods for Hackers in R + Stan"/>
  <meta property="og:locale" content="en_US"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Chapter 5"/>
  <meta property="twitter:description" content="Reproducing Chapter 5 of Bayesian Methods for Hackers in R + Stan"/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","preview","output"]}},"value":[{"type":"character","attributes":{},"value":["Chapter 5"]},{"type":"character","attributes":{},"value":["Reproducing Chapter 5 of Bayesian Methods for Hackers in R + Stan\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name"]}},"value":[{"type":"character","attributes":{},"value":["J. Duncan"]}]}]},{"type":"character","attributes":{},"value":["01-08-2021"]},{"type":"character","attributes":{},"value":["halo-example.png"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["bayes-hackr-ch5_files/figure-html5/unnamed-chunk-1-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-10-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-11-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-13-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-14-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-16-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-17-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-20-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-21-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-4-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-7-1.png","bayes-hackr-ch5_files/figure-html5/unnamed-chunk-8-1.png","data/Test_haloCounts.csv","data/Train_Skies/Training_Sky215.csv","data/Train_Skies/Training_Sky3.csv","data/Training_halos.csv","halo-example.png","models/ch5-mod1","models/ch5-mod1.stan","models/ch5-mod2","models/ch5-mod2-wfunc","models/ch5-mod2-wfunc.stan","models/ch5-mod2.stan","models/ch5-mod3","models/ch5-mod3.stan"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }
  
  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }
  
  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }
  
  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }
  
  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }
  
  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }
  
  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }
  
  d-article h3 {
    margin-top: 1.5rem;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  /* Tweak code blocks */
  
  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }
  
  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }
  
  d-article div.sourceCode {
    background-color: white;
  }
  
  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  d-article pre a {
    border-bottom: none;
  }
  
  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }
  
  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }
  
  @media(min-width: 768px) {
  
  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }
  
  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }
  
  d-article pre {
    font-size: 14px;
  }
  
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for d-contents */
  
  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }
  
  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }
  
  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }
  
  .d-contents li {
    list-style-type: none
  }
  
  .d-contents nav > ul {
    padding-left: 0;
  }
  
  .d-contents ul {
    padding-left: 1em
  }
  
  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }
  
  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }
  
  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }
  
  .d-contents nav > ul > li > a {
    font-weight: 600;
  }
  
  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }
  
  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }
  
  
  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }
  
  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }
  
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  /* Citations */
  
  d-article .citation {
    color: inherit;
    cursor: inherit;
  }
  
  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }
  
  /* Citation hover box */
  
  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }
  
  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  /* Include appendix styles here so they can be overridden */
  
  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }
  
  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }
  
  d-appendix h3 + * {
    margin-top: 1em;
  }
  
  d-appendix ol {
    padding: 0 0 0 15px;
  }
  
  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }
  
  d-appendix li {
    margin-bottom: 1em;
  }
  
  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  d-appendix > * {
    grid-column: text;
  }
  
  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }
  
  /* Include footnote styles here so they can be overridden */
  
  d-footnote-list {
    contain: layout style;
  }
  
  d-footnote-list > * {
    grid-column: text;
  }
  
  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }
  
  
  
  /* Anchor.js */
  
  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .custom p {
    margin-bottom: 0.5em;
  }
  
  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }
  
  /* Styles for posts lists (not auto-injected) */
  
  
  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }
  
  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }
  
  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }
  
  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }
  
  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }
  
  .post-preview-last {
    border-bottom: none !important;
  }
  
  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }
  
  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }
  
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }
  
  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }
  
  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }
  
  .posts-list .metadata > * {
    display: inline-block;
  }
  
  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }
  
  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }
  
  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }
  
  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }
  
  .posts-list img {
    opacity: 1;
  }
  
  .posts-list img[data-src] {
    opacity: 0;
  }
  
  .posts-more {
    clear: both;
  }
  
  
  .posts-sidebar {
    font-size: 16px;
  }
  
  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }
  
  .sidebar-section {
    margin-bottom: 30px;
  }
  
  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  
  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }
  
  .categories li>a {
    border-bottom: none;
  }
  
  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }
  
  .categories .active {
    font-weight: 600;
  }
  
  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }
  
  
  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  .downlevel .posts-list .post-preview {
    color: inherit;
  }
  
  
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }
  
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();
  
    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-contents').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="bayes-hackr-ch5_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="bayes-hackr-ch5_files/popper-2.6.0/popper.min.js"></script>
  <link href="bayes-hackr-ch5_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="bayes-hackr-ch5_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="bayes-hackr-ch5_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="bayes-hackr-ch5_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="bayes-hackr-ch5_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="bayes-hackr-ch5_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="bayes-hackr-ch5_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Chapter 5","description":"Reproducing Chapter 5 of Bayesian Methods for Hackers in R + Stan","authors":[{"author":"J. Duncan","authorURL":"#","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2021-01-08T00:00:00.000+00:00","citationText":"Duncan, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Chapter 5</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>Reproducing Chapter 5 of Bayesian Methods for Hackers in R + Stan</p></p>
</div>

<div class="d-byline">
  J. Duncan  
  
<br/>01-08-2021
</div>

<div class="d-article">
<h2 id="loss-functions">5.2 Loss Functions</h2>
<h3 id="example-optimizing-for-the-showcase-on-the-price-is-right">5.2.2 Example: Optimizing for the Showcase on <em>The Price Is Right</em></h3>
<p>We can start by visualizing some priors:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mjskay.github.io/tidybayes/'>tidybayes</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mc-stan.org/posterior/'>posterior</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://patchwork.data-imaginist.com'>patchwork</a></span><span class='op'>)</span>
<span class='fu'>theme_set</span><span class='op'>(</span><span class='fu'><a href='http://mjskay.github.io/ggdist/reference/theme_ggdist.html'>theme_tidybayes</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'>tribble</span><span class='op'>(</span>
  <span class='op'>~</span><span class='va'>var</span>, <span class='op'>~</span><span class='va'>mu</span>, <span class='op'>~</span><span class='va'>sd</span>,
  <span class='st'>"historical total prices"</span>, <span class='fl'>35000</span>, <span class='fl'>7500</span>,
  <span class='st'>"snowblower price guess"</span>, <span class='fl'>3000</span>, <span class='fl'>500</span>,
  <span class='st'>"trip price guess"</span>, <span class='fl'>12000</span>, <span class='fl'>3000</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_dist_slabinterval.html'>stat_dist_halfeye</a></span><span class='op'>(</span>
    <span class='fu'>aes</span><span class='op'>(</span>dist <span class='op'>=</span> <span class='fu'>distributional</span><span class='fu'>::</span><span class='fu'><a href='https://pkg.mitchelloharawild.com/distributional/reference/dist_normal.html'>dist_normal</a></span><span class='op'>(</span>mu <span class='op'>=</span> <span class='va'>mu</span>, sigma <span class='op'>=</span> <span class='va'>sd</span><span class='op'>)</span><span class='op'>)</span>,
    normalize <span class='op'>=</span> <span class='st'>"panels"</span>,
    orientation <span class='op'>=</span> <span class='st'>"horizontal"</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>var</span>, ncol <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    y <span class='op'>=</span> <span class='cn'>NULL</span>,
    x <span class='op'>=</span> <span class='cn'>NULL</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-1-1.png" width="624" /></p>
</div>
<p>There’s no <code>data</code> block here. We’re simply playing with priors which is kind of cool.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mod</span> <span class='op'>&lt;-</span> <span class='fu'>cmdstanr</span><span class='fu'>::</span><span class='fu'><a href='https://mc-stan.org/cmdstanr/reference/cmdstan_model.html'>cmdstan_model</a></span><span class='op'>(</span><span class='st'>"models/ch5-mod1.stan"</span><span class='op'>)</span>
<span class='va'>mod</span><span class='op'>$</span><span class='fu'>print</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>parameters {
  real true_price;
  real prize_1;
  real prize_2;
}

transformed parameters {
  real price_estimate;
  price_estimate = prize_1 + prize_2;
}

model {
  // priors
  true_price ~ normal(35000, 7500);
  prize_1 ~ normal(3000, 500);
  prize_2 ~ normal(12000, 3000);
  // updated price using priors of individual prizes
  true_price ~ normal(price_estimate, 3000);
}</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit</span> <span class='op'>&lt;-</span> <span class='va'>mod</span><span class='op'>$</span><span class='fu'>sample</span><span class='op'>(</span>
  seed <span class='op'>=</span> <span class='fl'>123</span>,
  chains <span class='op'>=</span> <span class='fl'>4</span>,
  parallel_chains <span class='op'>=</span> <span class='fl'>2</span>,
  refresh <span class='op'>=</span> <span class='fl'>1000</span>,
  iter_sampling <span class='op'>=</span> <span class='fl'>3000</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 chains, at most 2 in parallel...

Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 2 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 0.1 seconds.
Chain 2 finished in 0.1 seconds.
Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 3 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 4 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 3 finished in 0.1 seconds.
Chain 4 finished in 0.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.1 seconds.
Total execution time: 0.5 seconds.</code></pre>
</div>
<p>Now to visualize the <code>total_price</code> estimate:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># https://mpopov.com/blog/2020/09/07/pivoting-posteriors/</span>
<span class='va'>tidy_draws.CmdStanMCMC</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>model</span>, <span class='va'>...</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fu'><a href='https://mc-stan.org/posterior/reference/draws_df.html'>as_draws_df</a></span><span class='op'>(</span><span class='va'>model</span><span class='op'>$</span><span class='fu'>draws</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Now visualizing the prior information versus the posterior price estimate:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>priorp</span> <span class='op'>&lt;-</span> <span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_dist_slabinterval.html'>stat_dist_halfeye</a></span><span class='op'>(</span>
    <span class='fu'>aes</span><span class='op'>(</span>dist <span class='op'>=</span> <span class='fu'>distributional</span><span class='fu'>::</span><span class='fu'><a href='https://pkg.mitchelloharawild.com/distributional/reference/dist_normal.html'>dist_normal</a></span><span class='op'>(</span>mu <span class='op'>=</span> <span class='fl'>35000</span>, sigma <span class='op'>=</span> <span class='fl'>7500</span><span class='op'>)</span><span class='op'>)</span>,
    .width <span class='op'>=</span> <span class='fl'>0.25</span>,
    orientation <span class='op'>=</span> <span class='st'>"horizontal"</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='op'>(</span><span class='fl'>5000</span>, <span class='fl'>40000</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Prior distribution of suite price"</span>,
    y <span class='op'>=</span> <span class='cn'>NULL</span>,
    x <span class='op'>=</span> <span class='cn'>NULL</span>
  <span class='op'>)</span>

<span class='va'>postp</span> <span class='op'>&lt;-</span> <span class='va'>fit</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>true_price</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html'>stat_histinterval</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>.value</span><span class='op'>)</span>, .width <span class='op'>=</span> <span class='fl'>0.25</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='op'>(</span><span class='fl'>5000</span>, <span class='fl'>40000</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Posterior of the true price estimate"</span>,
    y <span class='op'>=</span> <span class='cn'>NULL</span>,
    x <span class='op'>=</span> <span class='cn'>NULL</span>
  <span class='op'>)</span>

<span class='va'>priorp</span> <span class='op'>/</span> <span class='va'>postp</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-4-1.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># with util function</span>
<span class='va'>risks</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>30000</span>, <span class='fl'>150000</span>, length.out <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span>
<span class='va'>guesses</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>5000</span>, <span class='fl'>50000</span>, length.out <span class='op'>=</span> <span class='fl'>70</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>I prefer the above method of just writing the utility function in Stan and using it to estimate the expected loss. However, there’s a limitation for the optimization process this way. It’s only as granular as the inputs we send to Stan. We could increase the resolution of <code>guesses</code> here and get something more accurate or just keep as is and select the best guess in our set of <code>70</code> guesses.</p>
<p>You can use the <code>optim</code> function to get a better choice using optimization by just using the posterior within the R environment. Something more like <a href="http://www.statsathome.com/2017/10/12/bayesian-decision-theory-made-ridiculously-simple/#the-loss-function">this</a> example which uses the <code>posterior_predict</code> function from the <code>brms</code> package. This is also better for scale once we start having more dimensions.</p>
<p>Define the loss function using the true_price posterior distribution</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>showdown_loss</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>guess</span>, <span class='va'>true_price</span>, <span class='va'>risk</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>loss</span> <span class='op'>&lt;-</span> <span class='fu'>case_when</span><span class='op'>(</span>
    <span class='va'>true_price</span><span class='op'>$</span><span class='va'>.value</span> <span class='op'>&lt;</span> <span class='va'>guess</span> <span class='op'>~</span> <span class='va'>risk</span>,
    <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>true_price</span><span class='op'>$</span><span class='va'>.value</span> <span class='op'>-</span> <span class='va'>guess</span><span class='op'>)</span> <span class='op'>&lt;=</span> <span class='fl'>250</span> <span class='op'>~</span> <span class='op'>-</span><span class='fl'>2</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>true_price</span><span class='op'>$</span><span class='va'>.value</span><span class='op'>)</span>,
    <span class='cn'>TRUE</span> <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>true_price</span><span class='op'>$</span><span class='va'>.value</span> <span class='op'>-</span> <span class='va'>guess</span> <span class='op'>-</span> <span class='fl'>250</span><span class='op'>)</span>
  <span class='op'>)</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>loss</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>post_df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>fit</span>, <span class='va'>true_price</span><span class='op'>)</span>

<span class='va'>dat</span> <span class='op'>&lt;-</span> <span class='fu'>crossing</span><span class='op'>(</span><span class='va'>guesses</span>, <span class='va'>risks</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span><span class='fu'>nest</span><span class='op'>(</span><span class='va'>post_df</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    loss <span class='op'>=</span> <span class='fu'>pmap_dbl</span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>guesses</span>, <span class='va'>data</span>, <span class='va'>risks</span><span class='op'>)</span>,
      <span class='op'>~</span> <span class='fu'>showdown_loss</span><span class='op'>(</span><span class='va'>..1</span>, <span class='va'>..2</span>, <span class='va'>..3</span><span class='op'>)</span>
      <span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>guesses</span>, <span class='va'>risks</span>, <span class='va'>loss</span><span class='op'>)</span>

<span class='va'>p</span> <span class='op'>&lt;-</span> <span class='va'>dat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>guesses</span>, y <span class='op'>=</span> <span class='va'>loss</span>, color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>ordered</a></span><span class='op'>(</span><span class='va'>risks</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='op'>(</span><span class='fl'>5000</span>, <span class='fl'>30000</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_color_viridis_d</span><span class='op'>(</span>
    name <span class='op'>=</span> <span class='st'>"Risk parameter"</span>,
    labels <span class='op'>=</span> <span class='va'>risks</span>
    <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Expected loss of different guesses"</span>,
    subtitle <span class='op'>=</span> <span class='st'>"various risk-levels of overestimating"</span>,
    x <span class='op'>=</span> <span class='st'>"price bid"</span>,
    y <span class='op'>=</span> <span class='st'>"expected loss"</span>
  <span class='op'>)</span> 
<span class='va'>p</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-7-1.png" width="864" /></p>
</div>
<h4 id="minimizing-our-losses">Minimizing our losses</h4>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>oppnts</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='va'>risks</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span><span class='fu'>nest</span><span class='op'>(</span><span class='va'>post_df</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    opt <span class='op'>=</span> <span class='fu'>map2</span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>risks</span>, <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/optim.html'>optim</a></span><span class='op'>(</span>
      <span class='fl'>5000</span>,
      fn <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>guess</span><span class='op'>)</span> <span class='fu'>showdown_loss</span><span class='op'>(</span><span class='va'>guess</span>, <span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span>
    <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    opt_tidy <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>opt</span>, <span class='fu'>broom</span><span class='fu'>::</span><span class='va'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>)</span>,
    opt_glance <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>opt</span>, <span class='fu'>broom</span><span class='fu'>::</span><span class='va'><a href='https://generics.r-lib.org/reference/glance.html'>glance</a></span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>unnest</span><span class='op'>(</span><span class='va'>opt_tidy</span>, <span class='va'>opt_glance</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>risks</span>, <span class='fu'>starts_with</span><span class='op'>(</span><span class='st'>"value"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rename</span><span class='op'>(</span>guesses <span class='op'>=</span> <span class='va'>value</span>, loss <span class='op'>=</span> <span class='va'>value1</span><span class='op'>)</span>

<span class='va'>p</span> <span class='op'>+</span> <span class='fu'>geom_vline</span><span class='op'>(</span>
  data <span class='op'>=</span> <span class='va'>oppnts</span>, 
  <span class='fu'>aes</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>guesses</span>, color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>ordered</a></span><span class='op'>(</span><span class='va'>risks</span><span class='op'>)</span><span class='op'>)</span>, 
  linetype <span class='op'>=</span> <span class='st'>"dashed"</span>
  <span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>scale_color_viridis_d</span><span class='op'>(</span>
    name <span class='op'>=</span> <span class='st'>"Bayes action at risk:"</span>,
    labels <span class='op'>=</span> <span class='va'>risks</span>
    <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Expected loss &amp; Bayes actions of different guesses"</span>,
    subtitle <span class='op'>=</span> <span class='st'>"various risk-levels of overestimating"</span>,
    x <span class='op'>=</span> <span class='st'>"price bid"</span>,
    y <span class='op'>=</span> <span class='st'>"expected loss"</span>
  <span class='op'>)</span> 
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-8-1.png" width="864" /></p>
</div>
<h2 id="machine-learning-via-bayesian-methods">5.3 Machine Learning via Bayesian Methods</h2>
<h3 id="example-financial-prediction">Example: Financial Prediction</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>stock_loss</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>true_return</span>, <span class='va'>yhat</span>, <span class='va'>alpha</span> <span class='op'>=</span> <span class='fl'>100.</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>loss</span> <span class='op'>&lt;-</span> <span class='fu'>if_else</span><span class='op'>(</span>
    <span class='va'>true_return</span> <span class='op'>*</span> <span class='va'>yhat</span> <span class='op'>&lt;</span> <span class='fl'>0</span>,
    <span class='va'>alpha</span> <span class='op'>*</span> <span class='va'>yhat</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>-</span> <span class='fu'><a href='https://rdrr.io/r/base/sign.html'>sign</a></span><span class='op'>(</span><span class='va'>true_return</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>yhat</span> <span class='op'>+</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>true_return</span><span class='op'>)</span>,
    <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>abs</a></span><span class='op'>(</span><span class='va'>true_return</span> <span class='op'>-</span> <span class='va'>yhat</span><span class='op'>)</span>
    <span class='op'>)</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>loss</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>pred</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.04</span>, <span class='fl'>0.12</span>, length.out <span class='op'>=</span> <span class='fl'>75</span><span class='op'>)</span>

<span class='va'>pred_df</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='va'>pred</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    `true_0.05` <span class='op'>=</span> <span class='fu'>stock_loss</span><span class='op'>(</span><span class='fl'>0.05</span>, <span class='va'>pred</span><span class='op'>)</span>,
    `true_-0.02` <span class='op'>=</span> <span class='fu'>stock_loss</span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.02</span>, <span class='va'>pred</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span><span class='op'>-</span><span class='va'>pred</span>, names_to <span class='op'>=</span> <span class='st'>"loss"</span>, names_prefix <span class='op'>=</span> <span class='st'>"true_"</span><span class='op'>)</span>

<span class='va'>pred_df</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>pred</span>, y <span class='op'>=</span> <span class='va'>value</span>, color <span class='op'>=</span> <span class='va'>loss</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/r/graphics/plot.window.html'>xlim</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>0.04</span>, <span class='fl'>.12</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/r/graphics/plot.window.html'>ylim</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0.25</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_vline</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='fl'>0.0</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='st'>"dashed"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Stock returns loss if true value = 0.05, -0.02"</span>,
    y <span class='op'>=</span> <span class='st'>"loss"</span>,
    x <span class='op'>=</span> <span class='st'>"prediction"</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_color_viridis_d</span><span class='op'>(</span>name <span class='op'>=</span> <span class='st'>"If true value = "</span><span class='op'>)</span> 
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-10-1.png" width="624" /></p>
</div>
<blockquote>
<p>We will perform a regression on a trading signal that we believe predicts future returns well. Our dataset is artificial, as most financial data is not even close to linear. Below, we plot the data along with the least-squares line.</p>
</blockquote>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'>## Code to create artificial data</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='fl'>123</span><span class='op'>)</span>
<span class='va'>N</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>
<span class='va'>X</span> <span class='op'>&lt;-</span> <span class='fl'>0.025</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N</span><span class='op'>)</span>
<span class='va'>Y</span> <span class='op'>&lt;-</span> <span class='fl'>0.5</span> <span class='op'>*</span> <span class='va'>X</span> <span class='op'>+</span> <span class='fl'>0.01</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N</span><span class='op'>)</span>
<span class='va'>artdat</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='va'>X</span>, <span class='va'>Y</span><span class='op'>)</span>

<span class='va'>ls_coef_</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cov</a></span><span class='op'>(</span><span class='va'>X</span>, <span class='va'>Y</span><span class='op'>)</span> <span class='op'>/</span> <span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>
<span class='va'>ls_intercept</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>Y</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>ls_coef_</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>

<span class='va'>artdat</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span><span class='va'>X</span>, <span class='va'>Y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_smooth</span><span class='op'>(</span>method <span class='op'>=</span> <span class='st'>"lm"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Empirical returns vs trading signal"</span>,
    x <span class='op'>=</span> <span class='st'>"trading signal"</span>,
    y <span class='op'>=</span> <span class='st'>"returns"</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-11-1.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>dat_list</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/compose_data.html'>compose_data</a></span><span class='op'>(</span><span class='va'>artdat</span><span class='op'>)</span>

<span class='va'>trading_signals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, length.out <span class='op'>=</span> <span class='fl'>50</span><span class='op'>)</span>
<span class='va'>dat_list</span><span class='op'>[[</span><span class='st'>"trading_signals"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>trading_signals</span>

<span class='va'>mod2</span> <span class='op'>&lt;-</span> <span class='fu'>cmdstanr</span><span class='fu'>::</span><span class='fu'><a href='https://mc-stan.org/cmdstanr/reference/cmdstan_model.html'>cmdstan_model</a></span><span class='op'>(</span><span class='st'>"models/ch5-mod2.stan"</span><span class='op'>)</span>
<span class='va'>mod2</span><span class='op'>$</span><span class='fu'>print</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>data {
  int&lt;lower=0&gt; n;
  vector[n] X;
  vector[n] Y;
  vector[50] trading_signals;
}

parameters {
  real beta;
  real alpha;
  real&lt;lower=0&gt; std;
}

model {
  alpha ~ normal(0, 100);
  beta ~ normal(0, 100);
  std ~ uniform(0, 100);
  Y ~ normal(alpha + beta * X, std);
}

generated quantities {
   vector[50] outcomes;
   for (i in 1:50)
     outcomes[i] = normal_rng(alpha + beta * trading_signals[i], std);
}</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit2</span> <span class='op'>&lt;-</span> <span class='va'>mod2</span><span class='op'>$</span><span class='fu'>sample</span><span class='op'>(</span>
  data <span class='op'>=</span> <span class='va'>dat_list</span>,
  seed <span class='op'>=</span> <span class='fl'>123</span>,
  chains <span class='op'>=</span> <span class='fl'>4</span>,
  parallel_chains <span class='op'>=</span> <span class='fl'>4</span>,
  refresh <span class='op'>=</span> <span class='fl'>1000</span>,
  iter_sampling <span class='op'>=</span> <span class='fl'>3000</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 0.7 seconds.
Chain 2 finished in 0.7 seconds.
Chain 4 finished in 0.7 seconds.
Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 3 finished in 0.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.7 seconds.
Total execution time: 0.8 seconds.</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit2</span>
</code></pre>
</div>
<pre><code>    variable   mean median   sd  mad     q5    q95 rhat ess_bulk
 lp__        408.34 408.67 1.23 1.03 405.89 409.68 1.00     4354
 beta          0.48   0.48 0.04 0.04   0.41   0.55 1.00     6048
 alpha         0.00   0.00 0.00 0.00   0.00   0.00 1.00    15685
 std           0.01   0.01 0.00 0.00   0.01   0.01 1.00     6125
 outcomes[1]  -0.03  -0.03 0.01 0.01  -0.05  -0.01 1.00    11571
 outcomes[2]  -0.03  -0.03 0.01 0.01  -0.04  -0.01 1.00    11097
 outcomes[3]  -0.03  -0.03 0.01 0.01  -0.04  -0.01 1.00    11161
 outcomes[4]  -0.03  -0.03 0.01 0.01  -0.04  -0.01 1.00    11186
 outcomes[5]  -0.02  -0.02 0.01 0.01  -0.04  -0.01 1.00    11457
 outcomes[6]  -0.02  -0.02 0.01 0.01  -0.04  -0.01 1.00    11457
 ess_tail
     5737
     5720
     9136
     5406
    11642
    11396
    11199
    11520
    11194
    11554

 # showing 10 of 54 rows (change via &#39;max_rows&#39; argument)</code></pre>
</div>
<p>Visualizing the marginal distributions:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>tidy_post</span> <span class='op'>&lt;-</span> <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>fit2</span>, <span class='va'>alpha</span>, <span class='va'>beta</span>, <span class='va'>std</span><span class='op'>)</span> 
  
<span class='va'>tidy_post</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>.value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html'>stat_histinterval</a></span><span class='op'>(</span>normalize <span class='op'>=</span> <span class='st'>"panels"</span>, show_interval <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span><span class='va'>.variable</span>, ncol <span class='op'>=</span> <span class='fl'>1</span>, scales <span class='op'>=</span> <span class='st'>"free"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Marginal Distributions"</span>, 
    y <span class='op'>=</span> <span class='cn'>NULL</span>,
    x <span class='op'>=</span> <span class='cn'>NULL</span>
  <span class='op'>)</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-13-1.png" width="624" /></p>
</div>
<p>Now for incorporating the loss function into our predictions:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>trading_signals</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, length.out <span class='op'>=</span> <span class='fl'>50</span><span class='op'>)</span>
<span class='va'>dat_list</span><span class='op'>[[</span><span class='st'>"trading_signals"</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>trading_signals</span>

<span class='va'>mod2_1</span> <span class='op'>&lt;-</span> <span class='fu'>cmdstanr</span><span class='fu'>::</span><span class='fu'><a href='https://mc-stan.org/cmdstanr/reference/cmdstan_model.html'>cmdstan_model</a></span><span class='op'>(</span><span class='st'>"models/ch5-mod2-wfunc.stan"</span><span class='op'>)</span>
<span class='va'>mod2_1</span><span class='op'>$</span><span class='fu'>print</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>functions {
  int sign(real x) {
    return x &lt; 0 ? -1 : 1;
  }
  
  real stock_loss(real true_return, real yhat) {
    real alpha = 100;
    if (true_return * yhat &lt; 0)
      return(alpha * yhat^2 - sign(true_return) * yhat + fabs(true_return));
    else
      return(fabs(true_return - yhat));
  }
}

data {
  int&lt;lower=0&gt; n;
  vector[n] X;
  vector[n] Y;
  vector[50] trading_signals;
}

parameters {
  real beta;
  real alpha;
  real&lt;lower=0&gt; std;
}

model {
  alpha ~ normal(0, 100);
  beta ~ normal(0, 100);
  std ~ uniform(0, 100);
  Y ~ normal(alpha + beta * X, std);
}

generated quantities {
   vector[50] outcomes;
   vector[50] util;
   
   for (i in 1:50){
     outcomes[i] = normal_rng(alpha + beta * trading_signals[i], std);
     util[i] = stock_loss(trading_signals[i], outcomes[i]);
   }
}</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit3</span> <span class='op'>&lt;-</span> <span class='va'>mod2_1</span><span class='op'>$</span><span class='fu'>sample</span><span class='op'>(</span>
  data <span class='op'>=</span> <span class='va'>dat_list</span>,
  seed <span class='op'>=</span> <span class='fl'>123</span>,
  chains <span class='op'>=</span> <span class='fl'>4</span>,
  parallel_chains <span class='op'>=</span> <span class='fl'>4</span>,
  refresh <span class='op'>=</span> <span class='fl'>1000</span>,
  iter_sampling <span class='op'>=</span> <span class='fl'>3000</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 3 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 0.8 seconds.
Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 2 finished in 0.9 seconds.
Chain 3 finished in 0.9 seconds.
Chain 4 finished in 0.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.9 seconds.
Total execution time: 1.0 seconds.</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>baction</span> <span class='op'>&lt;-</span> <span class='va'>fit3</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>util</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span>
  
<span class='fu'>tibble</span><span class='op'>(</span><span class='va'>trading_signals</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rowid_to_column</span><span class='op'>(</span>var <span class='op'>=</span> <span class='st'>"i"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>right_join</span><span class='op'>(</span><span class='va'>baction</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>trading_signals</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_lineribbon.html'>stat_lineribbon</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>.value</span><span class='op'>)</span>, .width <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>.99</span>, <span class='fl'>.95</span>, <span class='fl'>.8</span>, <span class='fl'>.5</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"#08519C"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_fill_brewer</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-14-1.png" width="624" /></p>
</div>
<p>We’re able to see the issue with predictions close to zero from the chart above. Given there are many returns that could be positive or negative in this range we see a spike in potential risk or loss. In this case our optimization should instead predict <code>0</code> to take no position. This quote from the book explains this all well:</p>
<blockquote>
<p>What is interesting about the above graph is that when the signal is near 0, and many of the possible returns outcomes are possibly both positive and negative, our best (with respect to our loss) prediction is to predict close to 0, hence take on no position. Only when we are very confident do we enter into a position. I call this style of model a sparse prediction, where we feel uncomfortable with our uncertainty so choose not to act. (Compare with the least-squares prediction which will rarely, if ever, predict zero).</p>
</blockquote>
<p>I think the only way we can optimize continuous decisions is to keep the utility/loss function all in the R session. I want to include it in Stan because it kind of wraps it all up nicely but I’m not sure how to minimize/maximize the loss functions here. In the Stan manual it says for <span class="math inline">\(k\)</span> discrete actions:</p>
<blockquote>
<p>It only remains to make the decision k with highest expected utility, which will correspond to the choice with the highest posterior mean for util[k]. This can be read off of the mean column of the Stan’s summary statistics or accessed programmatically through Stan’s interfaces.</p>
</blockquote>
<p>Then the following regarding continuous decisions:</p>
<blockquote>
<p>In these cases, the continuous choice can be coded as data in the Stan program. Then the expected utilities may be calculated. In other words, Stan can be used as a function from a choice to expected utilities. Then an external optimizer can call that function.</p>
</blockquote>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>ypred</span> <span class='op'>&lt;-</span> <span class='va'>fit2</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>gather_draws</a></span><span class='op'>(</span><span class='va'>outcomes</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>nest</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>bayesact</span> <span class='op'>&lt;-</span> <span class='va'>ypred</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    opt <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>data</span>, <span class='op'>~</span> <span class='fu'><a href='https://rdrr.io/r/stats/optim.html'>optim</a></span><span class='op'>(</span>
      <span class='fl'>0</span>,
      fn <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>yhat</span><span class='op'>)</span> <span class='fu'>stock_loss</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>$</span><span class='va'>.value</span>, <span class='va'>yhat</span>, alpha <span class='op'>=</span> <span class='fl'>500</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='op'>)</span>
    <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='op'>-</span><span class='va'>data</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    opt_tidy <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>opt</span>, <span class='fu'>broom</span><span class='fu'>::</span><span class='va'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>)</span>,
    opt_glance <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>opt</span>, <span class='fu'>broom</span><span class='fu'>::</span><span class='va'><a href='https://generics.r-lib.org/reference/glance.html'>glance</a></span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>unnest</span><span class='op'>(</span><span class='va'>opt_tidy</span>, <span class='va'>opt_glance</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rename</span><span class='op'>(</span>true_return <span class='op'>=</span> <span class='va'>value</span>, loss <span class='op'>=</span> <span class='va'>value1</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>i</span>, <span class='va'>true_return</span>, <span class='va'>loss</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ungroup</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Let’s visualize the predictions now:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>ols</span> <span class='op'>&lt;-</span> <span class='fu'>tibble</span><span class='op'>(</span><span class='va'>trading_signals</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rowid_to_column</span><span class='op'>(</span>var <span class='op'>=</span> <span class='st'>"i"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>pred <span class='op'>=</span> <span class='va'>ls_coef_</span> <span class='op'>*</span> <span class='va'>trading_signals</span> <span class='op'>+</span> <span class='va'>ls_intercept</span><span class='op'>)</span>

<span class='va'>bayesact</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>ols</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>trading_signals</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>true_return</span>, color <span class='op'>=</span> <span class='st'>"Bayes action"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred</span>, color <span class='op'>=</span> <span class='st'>"Least-squares"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_hline</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>yintercept <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='st'>"dashed"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>labs</span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Least-squares prediction vs. Bayes action prediction"</span>,
    x <span class='op'>=</span> <span class='st'>"trading signal"</span>,
    y <span class='op'>=</span> <span class='st'>"prediction"</span>
  <span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>scale_color_viridis_d</span><span class='op'>(</span>name <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-16-1.png" width="768" /></p>
</div>
<h3 id="example-kaggle-contest-on-observing-dark-worlds">5.3.2 Example: Kaggle Contest on Observing Dark Worlds</h3>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggforce.data-imaginist.com'>ggforce</a></span><span class='op'>)</span>

<span class='va'>sky3</span> <span class='op'>&lt;-</span> <span class='fu'>read_csv</span><span class='op'>(</span><span class='st'>"data/Train_Skies/Training_Sky3.csv"</span><span class='op'>)</span>

<span class='va'>size_multiplier</span> <span class='op'>&lt;-</span> <span class='fl'>25</span>

<span class='va'>sky3prep</span> <span class='op'>&lt;-</span> <span class='va'>sky3</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>
    d <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='va'>e1</span><span class='op'>^</span><span class='fl'>2</span> <span class='op'>+</span> <span class='va'>e2</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>,
    a <span class='op'>=</span> <span class='op'>(</span><span class='fl'>1.0</span> <span class='op'>/</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>d</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>size_multiplier</span>,
    b <span class='op'>=</span> <span class='op'>(</span><span class='fl'>1.0</span> <span class='op'>/</span> <span class='op'>(</span><span class='fl'>1</span> <span class='op'>+</span> <span class='va'>d</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>*</span> <span class='va'>size_multiplier</span>,
    theta <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Trig.html'>atan2</a></span><span class='op'>(</span><span class='va'>e2</span>, <span class='va'>e1</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>0.5</span>
  <span class='op'>)</span>

<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='va'>sky3prep</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggforce.data-imaginist.com/reference/geom_ellipse.html'>geom_ellipse</a></span><span class='op'>(</span>
    <span class='fu'>aes</span><span class='op'>(</span>x0 <span class='op'>=</span> <span class='va'>x</span>, y0 <span class='op'>=</span> <span class='va'>y</span>, a <span class='op'>=</span> <span class='va'>a</span>, b <span class='op'>=</span> <span class='va'>b</span>, angle <span class='op'>=</span> <span class='va'>theta</span><span class='op'>)</span>, 
    alpha <span class='op'>=</span> <span class='fl'>0.4</span>,
    fill <span class='op'>=</span> <span class='st'>'cyan4'</span>, 
    colour <span class='op'>=</span> <span class='st'>'cyan4'</span>
    <span class='op'>)</span>

<span class='va'>p2</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-17-1.png" width="624" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>dat_list2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
  n <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>sky3</span><span class='op'>)</span>,
  cart_pos <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>sky3</span><span class='op'>$</span><span class='va'>x</span>, <span class='va'>sky3</span><span class='op'>$</span><span class='va'>y</span><span class='op'>)</span>,
  ellip_pos <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>rbind</a></span><span class='op'>(</span><span class='va'>sky3</span><span class='op'>$</span><span class='va'>e1</span>, <span class='va'>sky3</span><span class='op'>$</span><span class='va'>e2</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Thanks to some help from the Stan community: <a href="https://discourse.mc-stan.org/t/help-with-vectorizing-stan-program/19957" class="uri">https://discourse.mc-stan.org/t/help-with-vectorizing-stan-program/19957</a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mod3</span> <span class='op'>&lt;-</span> <span class='fu'>cmdstanr</span><span class='fu'>::</span><span class='fu'><a href='https://mc-stan.org/cmdstanr/reference/cmdstan_model.html'>cmdstan_model</a></span><span class='op'>(</span><span class='st'>"models/ch5-mod3.stan"</span><span class='op'>)</span>
<span class='va'>mod3</span><span class='op'>$</span><span class='fu'>print</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>functions {
real f_distance(vector gxy_pos, vector halo_pos, real c) {
  return fmax(distance(gxy_pos, halo_pos), c);
}

vector tangential_distance(vector glxy_position, vector halo_position) {
  vector[2] delta = glxy_position - halo_position;
  real t = (2 * atan(delta[2] / delta[1]));
  return to_vector({-cos(t), -sin(t)});
}
}

data {
  int&lt;lower=0&gt; n;
  matrix[2, n] cart_pos; // x,y coordinates of galaxy position
  matrix[2, n] ellip_pos; // a measure of ellipticity
}

parameters {
  real&lt;lower=40.0,upper=180.0&gt; exp_mass_large;
  vector&lt;lower=0,upper=4200.0&gt;[2] halo_position;
}

transformed parameters {
  real mass_large = log(exp_mass_large); // one large halo
}

model {
  vector[2] mu; 
  
  for (i in 1:n) {
    mu = mass_large / f_distance(cart_pos[:, i], halo_position, 240.0) * 
      tangential_distance(cart_pos[:, i], halo_position); 
    ellip_pos[, i] ~ normal(mu, 0.05); // x-y coordinates
  }
}</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># sample with MCMC</span>
<span class='va'>fit4</span> <span class='op'>&lt;-</span> <span class='va'>mod3</span><span class='op'>$</span><span class='fu'>sample</span><span class='op'>(</span>
  data <span class='op'>=</span> <span class='va'>dat_list2</span>,
  seed <span class='op'>=</span> <span class='fl'>123</span>,
  chains <span class='op'>=</span> <span class='fl'>4</span>,
  parallel_chains <span class='op'>=</span> <span class='fl'>4</span>,
  refresh <span class='op'>=</span> <span class='fl'>1000</span>,
  iter_warmup <span class='op'>=</span> <span class='fl'>1000</span>,
  iter_sampling <span class='op'>=</span> <span class='fl'>3000</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>Running MCMC with 4 parallel chains...

Chain 3 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 1 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 4000 [  0%]  (Warmup) 
Chain 3 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 2 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 3 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 2 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 4000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1001 / 4000 [ 25%]  (Sampling) 
Chain 1 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 3 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 2 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 2000 / 4000 [ 50%]  (Sampling) 
Chain 1 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 1 finished in 52.4 seconds.
Chain 2 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 2 finished in 53.1 seconds.
Chain 3 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 3 finished in 53.3 seconds.
Chain 4 Iteration: 3000 / 4000 [ 75%]  (Sampling) 
Chain 4 Iteration: 4000 / 4000 [100%]  (Sampling) 
Chain 4 finished in 59.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 54.5 seconds.
Total execution time: 59.8 seconds.</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>fit4</span><span class='op'>$</span><span class='fu'>summary</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 5 x 10
  variable    mean  median      sd     mad      q5     q95  rhat
  &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 lp__     -1.18e4 -1.18e4  1.33    1.19   -1.18e4 -1.18e4  1.00
2 exp_mas…  1.73e2  1.75e2  7.13    5.31    1.58e2  1.80e2  1.00
3 halo_po…  2.33e3  2.34e3 32.7    33.0     2.28e3  2.39e3  1.00
4 halo_po…  1.19e3  1.19e3 56.3    48.7     1.08e3  1.26e3  1.00
5 mass_la…  5.15e0  5.16e0  0.0431  0.0302  5.06e0  5.19e0  1.00
# … with 2 more variables: ess_bulk &lt;dbl&gt;, ess_tail &lt;dbl&gt;</code></pre>
</div>
<p>Visualizing the halo location:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>halo_post</span> <span class='op'>&lt;-</span> <span class='va'>fit4</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>halo_position</span><span class='op'>[</span><span class='va'>coord</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_wider</span><span class='op'>(</span>names_from <span class='op'>=</span> <span class='va'>coord</span>, values_from <span class='op'>=</span> <span class='va'>halo_position</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rename</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>`1`</span>, y <span class='op'>=</span> <span class='va'>`2`</span><span class='op'>)</span>

<span class='va'>true_loc</span> <span class='op'>&lt;-</span> <span class='fu'>read_csv</span><span class='op'>(</span><span class='st'>"data/Training_halos.csv"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>SkyId</span> <span class='op'>==</span> <span class='st'>"Sky3"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rename</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>halo_x1</span>, y <span class='op'>=</span> <span class='va'>halo_y1</span><span class='op'>)</span>

<span class='va'>p2</span> <span class='op'>+</span> 
  <span class='fu'>geom_point</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>halo_post</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.015</span>, color <span class='op'>=</span> <span class='st'>"black"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_point</span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>true_loc</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>x</span>, y <span class='op'>=</span> <span class='va'>y</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"orange"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-20-1.png" width="624" /></p>
</div>
<p>A closer look at the true location parameters:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>true_loc</span> <span class='op'>&lt;-</span> <span class='fu'>read_csv</span><span class='op'>(</span><span class='st'>"data/Training_halos.csv"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>SkyId</span> <span class='op'>==</span> <span class='st'>"Sky3"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>rename</span><span class='op'>(</span>`1` <span class='op'>=</span> <span class='va'>halo_x1</span>, `2` <span class='op'>=</span> <span class='va'>halo_y1</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>`1`</span>, <span class='va'>`2`</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>pivot_longer</span><span class='op'>(</span><span class='va'>`1`</span><span class='op'>:</span><span class='va'>`2`</span>, names_to <span class='op'>=</span> <span class='st'>"coord"</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>mutate</span><span class='op'>(</span>coord <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>coord</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>fit4</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='http://mjskay.github.io/tidybayes/reference/spread_draws.html'>spread_draws</a></span><span class='op'>(</span><span class='va'>halo_position</span><span class='op'>[</span><span class='va'>coord</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>left_join</span><span class='op'>(</span><span class='va'>true_loc</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='http://mjskay.github.io/ggdist/reference/stat_sample_slabinterval.html'>stat_histinterval</a></span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>halo_position</span><span class='op'>)</span>, show_interval <span class='op'>=</span> <span class='cn'>FALSE</span>, breaks <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_vline</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>xintercept <span class='op'>=</span> <span class='va'>value</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='st'>"dashed"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>facet_wrap</span><span class='op'>(</span><span class='op'>~</span> <span class='va'>coord</span>, ncol <span class='op'>=</span> <span class='fl'>1</span>, scales <span class='op'>=</span> <span class='st'>"free"</span><span class='op'>)</span> 
</code></pre>
</div>
<p><img src="bayes-hackr-ch5_files/figure-html5/unnamed-chunk-21-1.png" width="624" /></p>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
